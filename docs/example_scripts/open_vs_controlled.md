# Compare "open" to "controlled" access type by provider, data year, data type

The following scripts were generated by Gemini. The prompts stated that we want to look at Metric_Type  = "Unique_Title_Requests" and group by calendar year, for all data in the TR table of a given date range (Jan 2021 through Oct 2025 in these examples) for the metric data (not to be confused with year of publication). They all round the percents to the nearest 0.1%.

### Percentages of the total for each provider
```
--Percentage of Grand Total
--This solution calculates the percentage that each row's Usage_Count represents out of the grand total Usage_Count for the entire provider result set. This is often the most useful metric for seeing which provider or access type contributes most to the overall usage.
--Explanation:
--We use a window function SUM(Usage_Count) OVER () to calculate the grand total across all rows returned by the query.
--We first calculate the Usage_Count in a Common Table Expression (CTE) to keep the logic clean, then perform the percentage calculation in the final SELECT statement.
WITH UsageCounts AS (
    SELECT
        Provider_Name,
        Access_Type,
        Data_Year,
        Data_Type,
        SUM(Metric_Usage) AS Usage_Count
    FROM
        TR
    WHERE
        access_method LIKE 'Regular'
        AND (Data_Year * 100 + Data_Month) BETWEEN 202101 AND 202508
        AND Metric_Type LIKE 'Unique_Item_Requests'
    GROUP BY
        Provider_Name,
        Data_Year,
        Access_Type,
        Data_Type
)
SELECT
    Provider_Name,
    Access_Type,
    Data_Year,
    Data_Type,
    Usage_Count,
    -- Calculate percentage within the provider/year group
    ROUND((Usage_Count * 100.0 / SUM(Usage_Count) OVER (PARTITION BY Provider_Name, Data_Year)),1) AS Percentage_of_Provider_Year_Total
FROM
    UsageCounts
ORDER BY
    Provider_Name,
    Data_Year,
    Data_Type,
    Access_Type;
```
### Percent open vs controlled within each provider, data type, and year
```
--Percentage within Each Provider and Year
--This solution answers a different, but also very useful question: "For a given provider in a given year, what percentage of its usage came from each Access_Type and Data_Type?"
--Explanation:
--Here, the window function is SUM(Usage_Count) OVER (PARTITION BY Provider_Name, Data_Year). 
--The PARTITION BY clause tells the SUM function to create separate totals for each unique combination of Provider_Name and Data_Year. 
--The percentage is then calculated against that specific sub-total.
WITH UsageCounts AS (
    SELECT
        Provider_Name,
        Access_Type,
        Data_Year,
        Data_Type,
        SUM(Metric_Usage) AS Usage_Count
    FROM
        TR
    WHERE
        access_method LIKE 'Regular'
        AND (Data_Year * 100 + Data_Month) BETWEEN 202101 AND 202508
        AND Metric_Type LIKE 'Unique_Item_Requests'
    GROUP BY
        Provider_Name,
        Data_Year,
        Access_Type,
        Data_Type
)
SELECT
    Provider_Name,
    Access_Type,
    Data_Year,
    Data_Type,
    Usage_Count,
    -- Calculate percentage within the provider/year group
    ROUND((Usage_Count * 100.0 / SUM(Usage_Count) OVER (PARTITION BY Provider_Name, Data_Year)),1) AS Percentage_of_Provider_Year_Total
FROM
    UsageCounts
ORDER BY
    Provider_Name,
    Data_Year,
    Data_Type,
    Access_Type;
```

### For each provider, show only years/data types where open uses are greater than controlled uses, give total
```
--This query will now group the "sub-total" by Provider_Name, Data_Year, AND Data_Type. 
--So, for a combination like ('Springer', 2023, 'Book'), it will calculate the total usage, and then the rows for 'Open' and 'Controlled' access will be shown as a percentage of that specific total.
--Explanation:
--The window function SUM(Usage_Count) OVER (PARTITION BY Provider_Name, Data_Year, Data_Type) creates a temporary total for each unique combination of those three columns. 
--This is the exact denominator you need for your percentage calculation.
WITH UsageCounts AS (
    SELECT
        Provider_Name,
        Access_Type,
        Data_Year,
        Data_Type,
        SUM(Metric_Usage) AS Usage_Count
    FROM
        TR
    WHERE
        access_method LIKE 'Regular'
        AND (Data_Year * 100 + Data_Month) BETWEEN 202101 AND 202508
        AND Metric_Type LIKE 'Unique_Item_Requests'
    GROUP BY
        Provider_Name,
        Data_Year,
        Access_Type,
        Data_Type
)
SELECT
    Provider_Name,
    Access_Type,
    Data_Year,
    Data_Type,
    Usage_Count,
    -- Calculate percentage within the Provider/Year/Data_Type group
    ROUND((Usage_Count * 100.0 / SUM(Usage_Count) OVER (PARTITION BY Provider_Name, Data_Year, Data_Type)),1) AS Percentage_of_Group
FROM
    UsageCounts
ORDER BY
    Provider_Name,
    Data_Year,
    Data_Type,
    Usage_Count DESC;our percentage calculation.
```
### Find per provider where open > controlled, give the usage counts

```
--Advanced Query: Directly Find Where Open > Controlled
-- This is a very powerful technique that uses conditional aggregation to pivot the data.
--Explanation:
--The first CTE UsageCounts is the same as before.
--The second CTE, PivotedCounts, groups by the context (Provider_Name, Data_Year, Data_Type) and uses CASE statements to create separate columns for 
--Open_Usage and Controlled_Usage.
--The final SELECT statement simply filters these results to show only the rows WHERE Open_Usage > Controlled_Usage.
--This query gives you the direct answer to your analytical question.
WITH UsageCounts AS (
    -- First, get the usage counts for each access type as before
    SELECT
        Provider_Name,
        Access_Type,
        Data_Year,
        Data_Type,
        SUM(Metric_Usage) AS Usage_Count
    FROM
        TR
    WHERE
        access_method LIKE 'Regular'
        AND (Data_Year * 100 + Data_Month) BETWEEN 202101 AND 202508
        AND Metric_Type LIKE 'Unique_Item_Requests'
    GROUP BY
        Provider_Name,
        Data_Year,
        Access_Type,
        Data_Type
),
PivotedCounts AS (
    -- Next, pivot the data to put Open and Controlled usage on the same row
    SELECT
        Provider_Name,
        Data_Year,
        Data_Type,
        SUM(CASE WHEN Access_Type LIKE 'Open' THEN Usage_Count ELSE 0 END) AS Open_Usage,
        SUM(CASE WHEN Access_Type LIKE 'Controlled' THEN Usage_Count ELSE 0 END) AS Controlled_Usage
    FROM
        UsageCounts
    GROUP BY
        Provider_Name,
        Data_Year,
        Data_Type
)
-- Finally, select only the rows that match your criteria
SELECT
    Provider_Name,
    Data_Year,
    Data_Type,
    Open_Usage,
    Controlled_Usage
FROM
    PivotedCounts
WHERE
    Open_Usage > Controlled_Usage
    AND Controlled_Usage > 0 -- Optional: use this to ignore cases where controlled usage was zero
ORDER BY
    Provider_Name,
    Data_Year,
    Data_Type;
```
